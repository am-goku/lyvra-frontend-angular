<div class="font-sans">
    <header class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-4">
        <h1 class="text-3xl font-bold text-gray-900 mb-4 sm:mb-0">Product Management</h1>
        <a routerLink="/admin/products/new" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Add Product
        </a>
    </header>

    <!-- Search, Filter, and Bulk Actions Section -->
    <div class="bg-white p-4 rounded-xl shadow-lg mb-6">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <!-- Search Input -->
            <div class="relative w-full md:w-1/3">
                <input type="text" placeholder="Search by product name or ID..." (input)="onSearch($event)"
                    class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                <!-- Icon: Search (lucide) -->
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"
                    xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8" />
                    <path d="m21 21-4.3-4.3" />
                </svg>
            </div>

            <!-- Category Filter -->
            <div class="w-full md:w-1/3">
                <select (change)="onFilter($event)"
                    class="w-full block appearance-none bg-white border border-gray-300 text-gray-700 py-2 px-4 rounded-lg leading-tight focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="all">Filter by Category (All)</option>
                    <option value="Electronics">Electronics</option>
                    <option value="Apparel">Apparel</option>
                    <option value="Home Goods">Home Goods</option>
                    <option value="Books">Books</option>
                </select>
            </div>

            <!-- Bulk Actions Bar (Visible when selected) -->
            <div *ngIf="selectedProducts().length > 0"
                class="w-full md:w-auto flex space-x-2 p-2 bg-indigo-50 rounded-lg border border-indigo-200 transition-all duration-300">
                <span class="text-sm font-medium text-indigo-700 py-1">{{ selectedProducts().length }} Selected:</span>
                <button (click)="bulkToggleListing(true)"
                    class="text-xs px-3 py-1 bg-green-500 text-white rounded-md hover:bg-green-600 transition">List</button>
                <button (click)="bulkToggleListing(false)"
                    class="text-xs px-3 py-1 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition">Unlist</button>
                <button (click)="bulkDelete()"
                    class="text-xs px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 transition">Delete</button>
            </div>
        </div>
    </div>

    <!-- Product Table -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <!-- Select All Checkbox -->
                        <th class="p-4 w-12 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            <input type="checkbox" [checked]="areAllSelected()" [indeterminate]="isIndeterminate()"
                                (change)="toggleSelectAll($event)"
                                class="rounded text-indigo-600 focus:ring-indigo-500">
                        </th>
                        <!-- Table Headers with Sorting -->
                        <ng-container *ngFor="let col of columns">
                            <th *ngIf="col.key !== 'image' && col.key !== 'description' && col.key !== 'specs'"
                                (click)="setSort($any(col.key))"
                                class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:text-indigo-600 transition">
                                <div class="flex items-center">
                                    {{ col.label }}
                                    <svg *ngIf="sortState().column === col.key" class="w-3 h-3 ml-1"
                                        xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path *ngIf="sortState().direction === 'asc'" d="M12 5V19M19 12L12 19L5 12" />
                                        <path *ngIf="sortState().direction === 'desc'" d="M12 19V5M5 12L12 5L19 12" />
                                    </svg>
                                </div>
                            </th>
                        </ng-container>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Status</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <tr *ngFor="let product of pagedProducts()" class="hover:bg-gray-50 transition duration-100">
                        <!-- Select Row Checkbox -->
                        <td class="p-4">
                            <input type="checkbox" [checked]="selectedProducts().includes(product.id)"
                                (change)="toggleProductSelection(product.id)"
                                class="rounded text-indigo-600 focus:ring-indigo-500">
                        </td>
                        <!-- Product Image/Name -->
                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <img [src]="product.imageUrl || 'assets/placeholder.png'" class="h-10 w-10 rounded-lg object-cover mr-3 shadow-sm"
                                    alt="{{ product.name }}">
                                <div>
                                    <div class="text-sm font-medium text-gray-900 truncate max-w-xs">{{ product.name }}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        {{ product.categories?.[0]?.name || 'Uncategorized' }}
                                        <span *ngIf="(product.categories?.length || 0) > 1">+{{ (product.categories?.length || 0) - 1 }} more</span>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <!-- Stock -->
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium"
                            [ngClass]="{'text-red-500': (product.stock || 0) < 10, 'text-green-600': (product.stock || 0) >= 10}">
                            {{ (product.stock || 0) | number }}
                        </td>
                        <!-- Price -->
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 font-semibold">
                            {{ (product.price || 0) | number:'1.2-2' }}$
                        </td>
                        <!-- Sales -->
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ (product.sales || 0) | number }}
                        </td>
                        <!-- Listed/Unlisted Status Toggle -->
                        <td class="px-4 py-4 whitespace-nowrap">
                            <span [ngClass]="{
                    'bg-green-100 text-green-800': product.isListed,
                    'bg-yellow-100 text-yellow-800': !product.isListed
                  }" class="px-3 inline-flex text-xs leading-5 font-semibold rounded-full">
                                {{ product.isListed ? 'Listed' : 'Unlisted' }}
                            </span>
                        </td>
                        <!-- Actions -->
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <button (click)="openProductModal(product)" [disabled]="selectedProducts().length > 0"
                                [ngClass]="{'opacity-50 cursor-not-allowed': selectedProducts().length > 0}"
                                title="Edit Product"
                                class="text-indigo-600 hover:text-indigo-900 disabled:opacity-50 transition p-1 rounded-full hover:bg-indigo-50">
                                <!-- Icon: Edit (lucide) -->
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" />
                                </svg>
                            </button>
                            <button (click)="deleteProduct(product.id)" [disabled]="selectedProducts().length > 0"
                                [ngClass]="{'opacity-50 cursor-not-allowed': selectedProducts().length > 0}"
                                title="Delete Product"
                                class="text-red-600 hover:text-red-900 disabled:opacity-50 transition p-1 rounded-full hover:bg-red-50">
                                <!-- Icon: Trash (lucide) -->
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                    viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 6h18" />
                                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Pagination Controls -->
    <div class="mt-6 flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
        <div class="text-sm text-gray-700">
            Showing {{ displayRange().start }} to {{ displayRange().end }} of {{ displayRange().total }} results
        </div>
        <div class="flex items-center space-x-1">
            <button (click)="changePage(currentPage() - 1)" [disabled]="currentPage() === 1"
                class="px-3 py-1 text-sm font-medium rounded-lg border transition duration-150"
                [ngClass]="{'bg-white text-gray-700 hover:bg-gray-100': currentPage() !== 1, 'bg-gray-200 text-gray-400 cursor-not-allowed': currentPage() === 1}">
                Previous
            </button>
            <span class="px-3 py-1 text-sm font-semibold text-indigo-600">Page {{ currentPage() }}</span>
            <button (click)="changePage(currentPage() + 1)" [disabled]="currentPage() >= totalPages()"
                class="px-3 py-1 text-sm font-medium rounded-lg border transition duration-150"
                [ngClass]="{'bg-white text-gray-700 hover:bg-gray-100': currentPage() < totalPages(), 'bg-gray-200 text-gray-400 cursor-not-allowed': currentPage() >= totalPages()}">
                Next
            </button>
        </div>
    </div>
</div>

<div *ngIf="isModalOpen()"
    class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
    <div
        class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto transform scale-100 transition-transform duration-300">
        <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white z-10">
            <h2 class="text-2xl font-bold text-gray-900">{{ editingProduct()?.id === -1 ? 'Add New Product' : 'Edit
                Product' }}</h2>
            <button (click)="closeProductModal()" class="text-gray-400 hover:text-gray-600">
                <!-- Icon: X (lucide) -->
                <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6 6 18" />
                    <path d="m6 6 12 12" />
                </svg>
            </button>
        </div>

        <div class="p-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column: Image and Status -->
            <div class="lg:col-span-1 space-y-4">
                <img [src]="editingProduct()?.imageUrl || 'assets/placeholder.png'"
                    class="w-full h-auto rounded-lg shadow-md object-cover" alt="Product Image">
                <div class="text-center">
                    <span [ngClass]="{
                'bg-green-500 hover:bg-green-600': editingProduct()?.isListed,
                'bg-yellow-500 hover:bg-yellow-600': !editingProduct()?.isListed
              }" class="px-4 py-2 inline-flex text-sm leading-5 font-bold rounded-full text-white cursor-pointer transition"
                        (click)="toggleListing(editingProduct()!)">
                        {{ editingProduct()?.isListed ? 'Toggle to Unlist' : 'Toggle to List' }}
                    </span>
                </div>
            </div>

            <!-- Right Column: Details and Form -->
            <div class="lg:col-span-2 space-y-4">
                <!-- Name and Category -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Product Name</label>
                    <input type="text" [value]="editingProduct()?.name" (input)="updateModalField('name', $event)"
                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Price ($)</label>
                        <input type="number" [value]="editingProduct()?.price"
                            (input)="updateModalField('price', $event)"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Stock</label>
                        <input type="number" [value]="editingProduct()?.stock"
                            (input)="updateModalField('stock', $event)"
                            class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea [value]="editingProduct()?.description" (input)="updateModalField('description', $event)"
                        rows="3"
                        class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 border focus:ring-indigo-500 focus:border-indigo-500 resize-none"></textarea>
                </div>

                <!-- Read-only Stats -->
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2">Sales Metrics</h3>
                    <p>Total Sales: <span class="font-bold text-indigo-600">{{ (editingProduct()?.sales || 0) | number }}
                            units</span></p>
                    <p>Product ID: <span class="font-mono text-xs text-gray-600">{{ editingProduct()?.id === -1 ? 'New'
                            : editingProduct()?.id }}</span></p>
                </div>

            </div>
        </div>

        <!-- Modal Footer Actions -->
        <div class="p-6 border-t flex justify-end space-x-3 sticky bottom-0 bg-white z-10">
            <button (click)="deleteProduct(editingProduct()!.id); closeProductModal()"
                *ngIf="editingProduct()?.id !== -1"
                class="px-4 py-2 bg-red-500 text-white font-medium rounded-lg shadow-md hover:bg-red-600 transition duration-150">
                Delete
            </button>
            <button (click)="saveProductChanges()"
                class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
                Save Changes
            </button>
        </div>
    </div>
</div>